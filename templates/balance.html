{% extends "base.html" %}
{% block title %}{{ t('balance') }} - SocialPay{% endblock %}
{% block content %}
<div class="page-header">
  <a href="/dashboard" class="back-btn">â†</a>
  <div class="page-title-wrap">
    <div class="page-title">ğŸ’° {{ t('balance') }}</div>
  </div>
</div>

<div class="page-content" style="padding:14px 14px 80px">
  <!-- BALANCE CHIPS -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
    <div class="card" style="background:linear-gradient(135deg,#0A2463,#1a3a8f);color:white;text-align:center">
      <div style="font-size:11px;opacity:0.7;margin-bottom:6px">â‚¦ Naira</div>
      <div style="font-size:24px;font-weight:800">â‚¦{{ "%.2f"|format(wallet.naira) }}</div>
    </div>
    <div class="card" style="background:linear-gradient(135deg,#06D6A0,#0ba360);color:white;text-align:center">
      <div style="font-size:11px;opacity:0.7;margin-bottom:6px">$ Dollar</div>
      <div style="font-size:24px;font-weight:800">${{ "%.4f"|format(wallet.dollar) }}</div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto">
    <button class="btn btn-primary btn-sm btn-icon" onclick="openModal('wdModal')">ğŸ§ {{ t('withdraw') }}</button>
    <button class="btn btn-sm btn-icon" style="background:linear-gradient(135deg,#4facfe,#00f2fe);color:#000;white-space:nowrap" onclick="openModal('exModal')">ğŸ’± {{ t('exchange') }}</button>
    <button class="btn btn-sm btn-icon" style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;white-space:nowrap" onclick="openModal('trModal')">ğŸ’¸ {{ t('transfer') }}</button>
  </div>

  <div class="alert alert-info">â„¹ï¸ Fee: {{ settings.withdrawal_fee_percent }}% | Min: â‚¦{{ "%.0f"|format(settings.min_withdrawal) }} | Rate: $1 = â‚¦{{ "%.0f"|format(settings.exchange_rate) }}</div>

  <!-- WITHDRAWALS -->
  <div class="section-header">
    <div class="section-title">ğŸ§ {{ t('withdraw') }} {{ t('history') }}</div>
  </div>
  <div class="card" style="padding:0;margin-bottom:16px">
    {% for w in withdrawals %}
    <div class="history-item" style="padding:14px 16px">
      <div class="hist-icon" style="background:{% if w.status=='approved' %}#D1FAE5{% elif w.status=='rejected' %}#FEE2E2{% else %}#FEF3C7{% endif %}">
        {% if w.status=='approved' %}âœ…{% elif w.status=='rejected' %}âŒ{% else %}â³{% endif %}
      </div>
      <div class="hist-info">
        <div class="hist-title">{{ t(w.status) }}</div>
        <div class="hist-time">{{ w.requested_at[:16] if w.requested_at else '' }}</div>
      </div>
      <div class="hist-amount amount-dr">-â‚¦{{ "%.2f"|format(w.amount) }}<br><span style="font-size:11px;color:var(--green)">Net: â‚¦{{ "%.2f"|format(w.net) }}</span></div>
    </div>
    {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">{{ t('history') }}</div>
    {% endfor %}
  </div>

  <!-- TRANSFERS -->
  <div class="section-header">
    <div class="section-title">ğŸ’¸ {{ t('transfer') }} {{ t('history') }}</div>
  </div>
  <div class="card" style="padding:0">
    {% for tr in (transfers_sent + transfers_recv)|sort(attribute='time', reverse=True) %}
    <div class="history-item" style="padding:14px 16px">
      <div class="hist-icon" style="background:{% if tr.sender_id==session.get('user_id') %}#FEE2E2{% else %}#D1FAE5{% endif %}">
        {% if tr.sender_id==session.get('user_id') %}ğŸ“¤{% else %}ğŸ“¥{% endif %}
      </div>
      <div class="hist-info">
        <div class="hist-title">{% if tr.sender_id==session.get('user_id') %}Sent{% else %}Received{% endif %}</div>
        <div class="hist-time">{{ tr.time[:16] if tr.time else '' }}</div>
        {% if tr.status=='reversed' %}<span class="badge badge-warning" style="font-size:10px">Reversed</span>{% endif %}
      </div>
      <div class="hist-amount {% if tr.sender_id==session.get('user_id') %}amount-dr{% else %}amount-cr{% endif %}">
        {% if tr.sender_id==session.get('user_id') %}-{% else %}+{% endif %}â‚¦{{ "%.2f"|format(tr.amount) }}
      </div>
    </div>
    {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">No transfers yet</div>
    {% endfor %}
  </div>
</div>

<!-- NAV -->
<nav class="bottom-nav">
  <a href="/dashboard" class="nav-item"><span class="nav-icon">ğŸ </span><span>Home</span></a>
  <a href="/tasks" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>{{ t('tasks') }}</span></a>
  <div class="nav-center-wrap"><a href="/balance" class="nav-center" style="background:linear-gradient(135deg,var(--green),#0ba360)">ğŸ’°</a></div>
  <a href="/referrals" class="nav-item"><span class="nav-icon">ğŸ‘¥</span><span>{{ t('referrals') }}</span></a>
  <a href="/profile" class="nav-item"><span class="nav-icon">ğŸ‘¤</span><span>{{ t('profile') }}</span></a>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="wdModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ§ {{ t('withdraw_money') }}</div>
    <div class="form-group"><label class="form-label">{{ t('currency') }}</label><select class="form-control" id="wd2-curr"><option value="naira">â‚¦ Naira</option><option value="dollar">$ Dollar</option></select></div>
    <div class="form-group"><label class="form-label">{{ t('amount') }}</label><input type="number" class="form-control" id="wd2-amt" placeholder="0.00"></div>
    <div class="form-group"><label class="form-label">{{ t('bank_details') }}</label><textarea class="form-control" id="wd2-bank" rows="3"></textarea></div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Fee: {{ settings.withdrawal_fee_percent }}%</div>
    <button class="btn btn-primary" id="wd2-btn" onclick="doWd()">{{ t('submit') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('wdModal')">{{ t('cancel') }}</button>
  </div>
</div>

<div class="modal-overlay" id="exModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’± {{ t('exchange_currency') }}</div>
    <div class="form-group"><label class="form-label">From</label><select class="form-control" id="ex2-from"><option value="naira">â‚¦ Naira â†’ $ Dollar</option><option value="dollar">$ Dollar â†’ â‚¦ Naira</option></select></div>
    <div class="form-group"><label class="form-label">{{ t('amount') }}</label><input type="number" class="form-control" id="ex2-amt" placeholder="0.00"></div>
    <button class="btn btn-primary" id="ex2-btn" onclick="doEx()">{{ t('exchange') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('exModal')">{{ t('cancel') }}</button>
  </div>
</div>

<div class="modal-overlay" id="trModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’¸ {{ t('send_money') }}</div>
    <div class="form-group"><label class="form-label">{{ t('receiver_id') }}</label><input type="text" class="form-control" id="tr2-recv" placeholder="SP12345678" oninput="lookupUser(this.value,'tr2-name')"><div id="tr2-name" style="font-size:13px;font-weight:700;margin-top:6px"></div></div>
    <div class="form-group"><label class="form-label">{{ t('amount') }} (â‚¦)</label><input type="number" class="form-control" id="tr2-amt" placeholder="0.00"></div>
    <div class="form-group"><label class="form-label">{{ t('pin') }}</label><input type="password" class="form-control" id="tr2-pin" maxlength="4" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢"></div>
    <button class="btn btn-primary" id="tr2-btn" onclick="doTr()">{{ t('send_now') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('trModal')">{{ t('cancel') }}</button>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
async function doWd() {
  const fd = new FormData();
  fd.append('currency',document.getElementById('wd2-curr').value);
  fd.append('amount',document.getElementById('wd2-amt').value);
  fd.append('bank_info',document.getElementById('wd2-bank').value);
  const r = await postForm('/withdraw',fd,document.getElementById('wd2-btn'));
  if(r?.success){closeModal('wdModal');setTimeout(()=>location.reload(),1400);}
}
async function doEx() {
  const fd = new FormData();
  fd.append('from_currency',document.getElementById('ex2-from').value);
  fd.append('amount',document.getElementById('ex2-amt').value);
  const r = await postForm('/exchange',fd,document.getElementById('ex2-btn'));
  if(r?.success){closeModal('exModal');setTimeout(()=>location.reload(),1400);}
}
async function doTr() {
  const fd = new FormData();
  fd.append('receiver_id',document.getElementById('tr2-recv').value.trim());
  fd.append('amount',document.getElementById('tr2-amt').value);
  fd.append('pin',document.getElementById('tr2-pin').value);
  const r = await postForm('/transfer',fd,document.getElementById('tr2-btn'));
  if(r?.success){closeModal('trModal');setTimeout(()=>location.reload(),1400);}
}
</script>
{% endblock %}
