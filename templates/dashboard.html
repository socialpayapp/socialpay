{% extends "base.html" %}
{% block title %}{{ t('app_name') }}{% endblock %}
{% block content %}

<!-- HEADER -->
<div class="app-header">
  <div class="header-top">
    <div class="app-logo">Social<span>Pay</span></div>
    <div class="header-icons">
      <a href="/notifications" class="icon-btn">
        ğŸ””
        <span class="badge-dot" id="notif-badge" {% if unread==0 %}style="display:none"{% endif %}>
          {{ unread if unread<=9 else '9+' }}
        </span>
      </a>
      <a href="/profile" class="icon-btn">ğŸ‘¤</a>
    </div>
  </div>
  <div class="user-greeting">{{ t('welcome_back') }} ğŸ‘‹</div>
  <div class="user-name">{{ user.name }}</div>

  <!-- LANG SWITCHER -->
  <div class="lang-bar" style="margin-top:12px">
    <a href="/set_lang/en" class="lang-btn {{ 'active' if lang=='en' else '' }}">EN</a>
    <a href="/set_lang/ar" class="lang-btn {{ 'active' if lang=='ar' else '' }}">Ø¹Ø±Ø¨ÙŠ</a>
    <a href="/set_lang/ha" class="lang-btn {{ 'active' if lang=='ha' else '' }}">HA</a>
  </div>
</div>

<div class="page-content">
  <!-- BALANCE CARD -->
  <div class="balance-card">
    <button class="eye-btn" id="eyeBtn" onclick="toggleBalance()">ğŸ‘ï¸</button>
    <div class="balance-label">{{ t('total_balance') }}</div>
    <div class="balance-amount">â‚¦{{ "%.2f"|format(wallet.naira) }}</div>
    <div class="balance-sub">{{ t('my_id') }}: {{ user.id }}</div>
    <div class="balance-chips">
      <div class="balance-chip">
        <div class="chip-label">ğŸ’µ Dollar</div>
        <div class="chip-value">${{ "%.4f"|format(wallet.dollar) }}</div>
      </div>
      <div class="balance-chip">
        <div class="chip-label">âœ… {{ t('completed_tasks') }}</div>
        <div class="chip-value">{{ wallet.completed_tasks }}</div>
      </div>
      <div class="balance-chip">
        <div class="chip-label">ğŸ‘¥ {{ t('referrals') }}</div>
        <div class="chip-value">{{ wallet.referral_count }}</div>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="section" style="padding-top:16px">
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-val" style="color:var(--green)">â‚¦{{ "%.0f"|format(wallet.total_earned) }}</div>
        <div class="stat-lbl">{{ t('total_earned') }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" style="color:var(--orange)">{{ wallet.pending_tasks }}</div>
        <div class="stat-lbl">{{ t('pending_tasks') }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" style="color:var(--red)">â‚¦{{ "%.0f"|format(wallet.total_withdrawn) }}</div>
        <div class="stat-lbl">{{ t('total_withdrawn') }}</div>
      </div>
    </div>
  </div>

  <!-- QUICK ACTIONS -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">âš¡ Quick Actions</div>
    </div>
    <div class="actions-grid">
      <a href="/tasks" class="action-item">
        <div class="action-icon icon-tasks">ğŸ“‹</div>
        <span class="action-label">{{ t('tasks') }}</span>
      </a>
      <a href="/balance" class="action-item">
        <div class="action-icon icon-balance">ğŸ’°</div>
        <span class="action-label">{{ t('balance') }}</span>
      </a>
      <div class="action-item" onclick="openModal('transferModal')">
        <div class="action-icon icon-transfer">ğŸ’¸</div>
        <span class="action-label">{{ t('transfer') }}</span>
      </div>
      <a href="/referrals" class="action-item">
        <div class="action-icon icon-referral">ğŸ‘¥</div>
        <span class="action-label">{{ t('referrals') }}</span>
      </a>
      <div class="action-item" onclick="openModal('withdrawModal')">
        <div class="action-icon icon-withdraw">ğŸ§</div>
        <span class="action-label">{{ t('withdraw') }}</span>
      </div>
      <div class="action-item" onclick="openModal('exchangeModal')">
        <div class="action-icon icon-exchange">ğŸ’±</div>
        <span class="action-label">{{ t('exchange') }}</span>
      </div>
      <a href="/profile" class="action-item">
        <div class="action-icon icon-profile">âš™ï¸</div>
        <span class="action-label">{{ t('profile') }}</span>
      </a>
      <a href="/my_submissions" class="action-item">
        <div class="action-icon icon-history">ğŸ“Š</div>
        <span class="action-label">{{ t('history') }}</span>
      </a>
    </div>
  </div>

  <!-- MY ID -->
  <div class="section">
    <div class="id-card">
      <div class="id-label">{{ t('my_id') }}</div>
      <div class="copy-row">
        <input type="text" value="{{ user.id }}" readonly>
        <button class="copy-btn" onclick="copyText('{{ user.id }}', 'ID Copied!')">{{ t('copy') }}</button>
      </div>
    </div>
  </div>

  <div style="height:16px"></div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <a href="/dashboard" class="nav-item">
    <span class="nav-icon">ğŸ </span><span>{{ t('balance') }}</span>
  </a>
  <a href="/tasks" class="nav-item">
    <span class="nav-icon">ğŸ“‹</span><span>{{ t('tasks') }}</span>
  </a>
  <div class="nav-center-wrap">
    <a href="/balance" class="nav-center">ğŸ’°</a>
  </div>
  <a href="/referrals" class="nav-item">
    <span class="nav-icon">ğŸ‘¥</span><span>{{ t('referrals') }}</span>
  </a>
  <a href="/profile" class="nav-item">
    <span class="nav-icon">ğŸ‘¤</span><span>{{ t('profile') }}</span>
  </a>
</nav>

<!-- WITHDRAW MODAL -->
<div class="modal-overlay" id="withdrawModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ§ {{ t('withdraw_money') }}</div>
    <div class="form-group">
      <label class="form-label">{{ t('currency') }}</label>
      <select class="form-control" id="wd-curr"><option value="naira">â‚¦ Naira</option><option value="dollar">$ Dollar</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('amount') }}</label>
      <input type="number" class="form-control" id="wd-amt" placeholder="0.00">
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('bank_details') }}</label>
      <textarea class="form-control" id="wd-bank" rows="3" placeholder="{{ t('bank_name') }} / {{ t('account_number') }}..."></textarea>
    </div>
    <button class="btn btn-primary" id="wd-btn" onclick="doWithdraw()">ğŸ’¸ {{ t('submit') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('withdrawModal')">{{ t('cancel') }}</button>
  </div>
</div>

<!-- TRANSFER MODAL -->
<div class="modal-overlay" id="transferModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’¸ {{ t('send_money') }}</div>
    <div class="form-group">
      <label class="form-label">{{ t('receiver_id') }}</label>
      <input type="text" class="form-control" id="tr-recv" placeholder="SP12345678" oninput="lookupUser(this.value,'tr-name')">
      <div id="tr-name" style="font-size:13px;font-weight:700;margin-top:6px;min-height:18px"></div>
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('amount') }} (â‚¦)</label>
      <input type="number" class="form-control" id="tr-amt" placeholder="0.00">
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('pin') }}</label>
      <input type="password" class="form-control" id="tr-pin" maxlength="4" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢">
    </div>
    <button class="btn btn-primary" id="tr-btn" onclick="doTransfer()">{{ t('send_now') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('transferModal')">{{ t('cancel') }}</button>
    <p style="text-align:center;margin-top:12px;font-size:12px;color:var(--muted)">
      <a href="/profile" style="color:var(--accent);font-weight:700">{{ t('set_pin') }} â†’</a>
    </p>
  </div>
</div>

<!-- EXCHANGE MODAL -->
<div class="modal-overlay" id="exchangeModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’± {{ t('exchange_currency') }}</div>
    <div class="card" style="background:#f0f4ff;padding:12px;margin-bottom:16px">
      <div style="font-size:13px;color:var(--muted)">{{ t('total_balance') }}</div>
      <div style="font-weight:800">â‚¦{{ "%.2f"|format(wallet.naira) }} | ${{ "%.4f"|format(wallet.dollar) }}</div>
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('exchange') }}</label>
      <select class="form-control" id="ex-from">
        <option value="naira">â‚¦ Naira â†’ $ Dollar</option>
        <option value="dollar">$ Dollar â†’ â‚¦ Naira</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('amount') }}</label>
      <input type="number" class="form-control" id="ex-amt" placeholder="0.00">
    </div>
    <button class="btn btn-primary" id="ex-btn" onclick="doExchange()">ğŸ’± {{ t('exchange') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('exchangeModal')">{{ t('cancel') }}</button>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
async function doWithdraw() {
  const fd = new FormData();
  fd.append('currency', document.getElementById('wd-curr').value);
  fd.append('amount', document.getElementById('wd-amt').value);
  fd.append('bank_info', document.getElementById('wd-bank').value);
  const r = await postForm('/withdraw', fd, document.getElementById('wd-btn'));
  if (r?.success) { closeModal('withdrawModal'); setTimeout(() => location.reload(), 1400); }
}
async function doTransfer() {
  const fd = new FormData();
  fd.append('receiver_id', document.getElementById('tr-recv').value.trim());
  fd.append('amount', document.getElementById('tr-amt').value);
  fd.append('pin', document.getElementById('tr-pin').value);
  const r = await postForm('/transfer', fd, document.getElementById('tr-btn'));
  if (r?.success) { closeModal('transferModal'); setTimeout(() => location.reload(), 1400); }
}
async function doExchange() {
  const fd = new FormData();
  fd.append('from_currency', document.getElementById('ex-from').value);
  fd.append('amount', document.getElementById('ex-amt').value);
  const r = await postForm('/exchange', fd, document.getElementById('ex-btn'));
  if (r?.success) { closeModal('exchangeModal'); setTimeout(() => location.reload(), 1400); }
}
</script>
{% endblock %}
