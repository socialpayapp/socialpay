<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ 'rtl' if lang == 'ar' else 'ltr' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0A2463">
  <title>{{ t('app_name') }}</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .announce-wrap{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;z-index:9500;pointer-events:none}
    .announce-banner{pointer-events:all;animation:slideDB .55s cubic-bezier(0.34,1.56,0.64,1) forwards}
    @keyframes slideDB{from{opacity:0;transform:translateY(-110%)}to{opacity:1;transform:translateY(0)}}
    .announce-inner{background:linear-gradient(135deg,#1a0533,#3d0d6b);color:white;padding:13px 16px 13px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 28px rgba(0,0,0,.45)}
    .announce-icon{font-size:22px;flex-shrink:0;animation:pulse2 1.4s ease-in-out infinite}
    @keyframes pulse2{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}
    .announce-text{flex:1;font-size:13px;font-weight:700;line-height:1.5}
    .announce-tag{font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
    .announce-close{background:rgba(255,255,255,.15);border:none;border-radius:8px;width:30px;height:30px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .pending-wd-alert{background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:2px solid #F59E0B;border-radius:16px;padding:16px 18px;margin:14px 16px 0;display:flex;align-items:flex-start;gap:14px;box-shadow:0 4px 16px rgba(245,158,11,.2)}
    .pwd-icon{font-size:30px;animation:wobb 2s ease-in-out infinite;flex-shrink:0}
    @keyframes wobb{0%,100%{transform:rotate(0)}25%{transform:rotate(-15deg)}75%{transform:rotate(15deg)}}
    .pwd-title{font-size:14px;font-weight:800;color:#92400E;margin-bottom:4px}
    .pwd-desc{font-size:12px;color:#B45309;line-height:1.6}
    .pwd-count{display:inline-flex;align-items:center;justify-content:center;background:#F59E0B;color:white;font-size:11px;font-weight:800;min-width:22px;height:22px;border-radius:11px;padding:0 6px;margin-left:6px}
  </style>
</head>
<body>

{% if announcement %}
<div class="announce-wrap" id="announceWrap">
  <div class="announce-banner">
    <div class="announce-inner">
      <div class="announce-icon">ğŸ“¢</div>
      <div class="announce-text">
        <div class="announce-tag">ğŸ“£ Announcement</div>
        {{ announcement }}
      </div>
      <button class="announce-close" onclick="closeBanner()">âœ•</button>
    </div>
  </div>
</div>
<div style="height:62px" id="bannerSpacer"></div>
{% endif %}

<div class="app-header">
  <div class="header-top">
    <div class="app-logo">Social<span>Pay</span></div>
    <div class="header-icons">
      <a href="/notifications" class="icon-btn">ğŸ””
        <span class="badge-dot" id="notif-badge" {% if unread==0 %}style="display:none"{% endif %}>{{ unread if unread<=9 else '9+' }}</span>
      </a>
      <a href="/profile" class="icon-btn">ğŸ‘¤</a>
    </div>
  </div>
  <div class="user-greeting">{{ t('welcome_back') }} ğŸ‘‹</div>
  <div class="user-name">{{ user.name }}</div>
  <div class="lang-bar" style="margin-top:12px">
    <a href="/set_lang/en" class="lang-btn {{ 'active' if lang=='en' else '' }}">EN</a>
    <a href="/set_lang/ar" class="lang-btn {{ 'active' if lang=='ar' else '' }}">Ø¹Ø±Ø¨ÙŠ</a>
    <a href="/set_lang/ha" class="lang-btn {{ 'active' if lang=='ha' else '' }}">HA</a>
  </div>
</div>

<div class="page-content">

  {% if pending_wd > 0 %}
  <div class="pending-wd-alert">
    <div class="pwd-icon">â³</div>
    <div style="flex:1">
      <div class="pwd-title">
        {% if lang=='ha' %}Ficewa Tana Jira{% elif lang=='ar' %}Ø§Ù„Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±{% else %}Withdrawal Pending{% endif %}
        <span class="pwd-count">{{ pending_wd }}</span>
      </div>
      <div class="pwd-desc">
        {% if lang=='ha' %}BuÆ™atarka ta ficewa tana jiran amincewan admin. Da fatan za a huta.{% elif lang=='ar' %}Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.{% else %}Your withdrawal request is awaiting admin approval. You'll be notified once processed.{% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="balance-card" style="margin-top:16px">
    <button class="eye-btn" id="eyeBtn" onclick="toggleBalance()">ğŸ‘ï¸</button>
    <div class="balance-label">{{ t('total_balance') }}</div>
    <div class="balance-amount">â‚¦{{ "%.2f"|format(wallet.naira) }}</div>
    <div class="balance-sub">{{ t('my_id') }}: {{ user.id }}</div>
    <div class="balance-chips">
      <div class="balance-chip"><div class="chip-label">ğŸ’µ Dollar</div><div class="chip-value">${{ "%.4f"|format(wallet.dollar) }}</div></div>
      <div class="balance-chip"><div class="chip-label">âœ… Tasks</div><div class="chip-value">{{ wallet.completed_tasks }}</div></div>
      <div class="balance-chip"><div class="chip-label">ğŸ‘¥ Refs</div><div class="chip-value">{{ wallet.referral_count }}</div></div>
    </div>
  </div>

  <div class="section" style="padding-top:16px">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--green)">â‚¦{{ "%.0f"|format(wallet.total_earned) }}</div><div class="stat-lbl">{{ t('total_earned') }}</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">{{ wallet.pending_tasks }}</div><div class="stat-lbl">{{ t('pending_tasks') }}</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--red)">â‚¦{{ "%.0f"|format(wallet.total_withdrawn) }}</div><div class="stat-lbl">{{ t('total_withdrawn') }}</div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header"><div class="section-title">âš¡ Quick Actions</div></div>
    <div class="actions-grid">
      <a href="/tasks" class="action-item"><div class="action-icon icon-tasks">ğŸ“‹</div><span class="action-label">{{ t('tasks') }}</span></a>
      <a href="/balance" class="action-item"><div class="action-icon icon-balance">ğŸ’°</div><span class="action-label">{{ t('balance') }}</span></a>
      <div class="action-item" onclick="openModal('transferModal')"><div class="action-icon icon-transfer">ğŸ’¸</div><span class="action-label">{{ t('transfer') }}</span></div>
      <a href="/referrals" class="action-item"><div class="action-icon icon-referral">ğŸ‘¥</div><span class="action-label">{{ t('referrals') }}</span></a>
      <div class="action-item" onclick="openModal('withdrawModal')"><div class="action-icon icon-withdraw">ğŸ§</div><span class="action-label">{{ t('withdraw') }}</span></div>
      <div class="action-item" onclick="openModal('exchangeModal')"><div class="action-icon icon-exchange">ğŸ’±</div><span class="action-label">{{ t('exchange') }}</span></div>
      <a href="/profile" class="action-item"><div class="action-icon icon-profile">âš™ï¸</div><span class="action-label">{{ t('profile') }}</span></a>
      <a href="/my_submissions" class="action-item"><div class="action-icon icon-history">ğŸ“Š</div><span class="action-label">{{ t('history') }}</span></a>
      <a href="/support" class="action-item"><div class="action-icon" style="background:linear-gradient(135deg,#06D6A0,#0ba360)">ğŸ«</div><span class="action-label">Support</span></a>
    </div>
  </div>

  <div class="section">
    <div class="id-card">
      <div class="id-label">{{ t('my_id') }}</div>
      <div class="copy-row">
        <input type="text" value="{{ user.id }}" readonly>
        <button class="copy-btn" onclick="copyText('{{ user.id }}','ID Copied!')">{{ t('copy') }}</button>
      </div>
    </div>
  </div>
  <div style="height:16px"></div>
</div>

<nav class="bottom-nav">
  <a href="/dashboard" class="nav-item active"><span class="nav-icon">ğŸ </span><span>Home</span></a>
  <a href="/tasks" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>{{ t('tasks') }}</span></a>
  <div class="nav-center-wrap"><a href="/balance" class="nav-center">ğŸ’°</a></div>
  <a href="/referrals" class="nav-item"><span class="nav-icon">ğŸ‘¥</span><span>{{ t('referrals') }}</span></a>
  <a href="/support" class="nav-item"><span class="nav-icon">ğŸ«</span><span>Support</span></a>
</nav>

<!-- WITHDRAW MODAL -->
<div class="modal-overlay" id="withdrawModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ§ {{ t('withdraw_money') }}</div>
    <div class="form-group">
      <label class="form-label">{{ t('currency') }}</label>
      <select class="form-control" id="wd-curr" onchange="toggleWdFields()">
        <option value="naira">â‚¦ Naira</option>
        <option value="dollar">$ Dollar / Crypto</option>
      </select>
    </div>
    <!-- NAIRA BANKS -->
    <div id="naira-banks">
      <div class="form-group">
        <label class="form-label">Select Bank</label>
        <select class="form-control" id="wd-bank-sel" onchange="onBankSel()">
          <option value="">-- Choose Bank --</option>
          <optgroup label="ğŸ’³ Mobile Money">
            <option>OPay</option><option>PalmPay</option><option>Kuda Bank</option>
            <option>Moniepoint</option><option>Carbon</option><option>FairMoney</option><option>Chipper Cash</option>
          </optgroup>
          <optgroup label="ğŸ¦ Commercial Banks">
            <option>Access Bank</option><option>GTBank</option><option>First Bank</option>
            <option>Zenith Bank</option><option>UBA</option><option>Ecobank</option>
            <option>Fidelity Bank</option><option>Sterling Bank</option><option>Union Bank</option>
            <option>Wema Bank</option><option>Polaris Bank</option><option>Unity Bank</option>
            <option>Heritage Bank</option><option>Keystone Bank</option><option>Stanbic IBTC</option>
            <option>Standard Chartered</option><option>Citibank Nigeria</option><option>Jaiz Bank</option>
          </optgroup>
          <option value="OTHER">âœï¸ Other (Type below)</option>
        </select>
      </div>
      <div class="form-group" id="bank-other-wrap" style="display:none">
        <label class="form-label">Bank Name</label>
        <input type="text" class="form-control" id="wd-bank-other" placeholder="Enter bank name...">
      </div>
      <div class="form-group">
        <label class="form-label">Account Number</label>
        <input type="text" class="form-control" id="wd-acct" placeholder="0123456789" inputmode="numeric" maxlength="10">
      </div>
      <div class="form-group">
        <label class="form-label">Account Name</label>
        <input type="text" class="form-control" id="wd-aname" placeholder="Your full name on account">
      </div>
    </div>
    <!-- CRYPTO -->
    <div id="crypto-banks" style="display:none">
      <div class="form-group">
        <label class="form-label">Crypto Wallet</label>
        <select class="form-control" id="wd-crypto-sel" onchange="onCryptoSel()">
          <option value="">-- Choose Wallet --</option>
          <optgroup label="ğŸ“± Crypto Apps">
            <option>Binance</option><option>Bitget</option><option>Bybit</option>
            <option>OKX</option><option>KuCoin</option><option>Coinbase</option>
            <option>Trust Wallet</option><option>Metamask</option><option>Remitano</option>
            <option>Luno</option><option>Noones</option><option>Paxful</option>
          </optgroup>
          <option value="OTHER">âœï¸ Other (Type below)</option>
        </select>
      </div>
      <div class="form-group" id="crypto-other-wrap" style="display:none">
        <label class="form-label">Wallet Name</label>
        <input type="text" class="form-control" id="wd-crypto-other" placeholder="Enter wallet name...">
      </div>
      <div class="form-group">
        <label class="form-label">Address / Username / UID</label>
        <input type="text" class="form-control" id="wd-addr" placeholder="e.g. USDT TRC20 address">
      </div>
      <div class="form-group">
        <label class="form-label">Network / Coin</label>
        <select class="form-control" id="wd-net">
          <option>USDT TRC20</option><option>USDT BEP20</option><option>USDT ERC20</option>
          <option>BTC</option><option>ETH</option><option>BNB</option><option>Other</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">{{ t('amount') }}</label>
      <input type="number" class="form-control" id="wd-amt" placeholder="0.00">
    </div>
    <button class="btn btn-primary" id="wd-btn" onclick="doWithdraw()">ğŸ’¸ {{ t('submit') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('withdrawModal')">{{ t('cancel') }}</button>
  </div>
</div>

<!-- TRANSFER MODAL -->
<div class="modal-overlay" id="transferModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’¸ {{ t('send_money') }}</div>
    <div class="form-group"><label class="form-label">{{ t('receiver_id') }}</label>
      <input type="text" class="form-control" id="tr-recv" placeholder="SP12345678" oninput="lookupUser(this.value,'tr-name')">
      <div id="tr-name" style="font-size:13px;font-weight:700;margin-top:6px;min-height:18px"></div>
    </div>
    <div class="form-group"><label class="form-label">{{ t('amount') }} (â‚¦)</label><input type="number" class="form-control" id="tr-amt" placeholder="0.00"></div>
    <div class="form-group"><label class="form-label">{{ t('pin') }}</label><input type="password" class="form-control" id="tr-pin" maxlength="4" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢"></div>
    <button class="btn btn-primary" id="tr-btn" onclick="doTransfer()">{{ t('send_now') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('transferModal')">{{ t('cancel') }}</button>
  </div>
</div>

<!-- EXCHANGE MODAL -->
<div class="modal-overlay" id="exchangeModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’± {{ t('exchange_currency') }}</div>
    <div class="form-group"><label class="form-label">From â†’ To</label>
      <select class="form-control" id="ex-from"><option value="naira">â‚¦ Naira â†’ $ Dollar</option><option value="dollar">$ Dollar â†’ â‚¦ Naira</option></select>
    </div>
    <div class="form-group"><label class="form-label">{{ t('amount') }}</label><input type="number" class="form-control" id="ex-amt" placeholder="0.00"></div>
    <button class="btn btn-primary" id="ex-btn" onclick="doExchange()">ğŸ’± {{ t('exchange') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('exchangeModal')">{{ t('cancel') }}</button>
  </div>
</div>

<div id="toast-container" class="toast-container"></div>
<script src="/static/js/app.js"></script>
<script>
function closeBanner(){document.getElementById('announceWrap')?.remove();document.getElementById('bannerSpacer')?.remove();sessionStorage.setItem('sp_bc','1');}
if(sessionStorage.getItem('sp_bc')){document.getElementById('announceWrap')?.remove();document.getElementById('bannerSpacer')?.remove();}
function toggleWdFields(){const c=document.getElementById('wd-curr').value;document.getElementById('naira-banks').style.display=c==='naira'?'':'none';document.getElementById('crypto-banks').style.display=c==='dollar'?'':'none';}
function onBankSel(){document.getElementById('bank-other-wrap').style.display=document.getElementById('wd-bank-sel').value==='OTHER'?'':'none';}
function onCryptoSel(){document.getElementById('crypto-other-wrap').style.display=document.getElementById('wd-crypto-sel').value==='OTHER'?'':'none';}
function buildBankInfo(){
  const c=document.getElementById('wd-curr').value;
  if(c==='naira'){
    const sel=document.getElementById('wd-bank-sel').value;
    const bank=sel==='OTHER'?document.getElementById('wd-bank-other').value.trim():sel;
    const acct=document.getElementById('wd-acct').value.trim();
    const nm=document.getElementById('wd-aname').value.trim();
    if(!bank||!acct||!nm){showToast('Fill all bank details','warning');return null;}
    return `Bank: ${bank}\nAccount: ${acct}\nName: ${nm}`;
  } else {
    const sel=document.getElementById('wd-crypto-sel').value;
    const w=sel==='OTHER'?document.getElementById('wd-crypto-other').value.trim():sel;
    const addr=document.getElementById('wd-addr').value.trim();
    const net=document.getElementById('wd-net').value;
    if(!w||!addr){showToast('Fill wallet details','warning');return null;}
    return `Wallet: ${w}\nAddress: ${addr}\nNetwork: ${net}`;
  }
}
async function doWithdraw(){
  const bi=buildBankInfo(); if(!bi) return;
  const fd=new FormData();
  fd.append('currency',document.getElementById('wd-curr').value);
  fd.append('amount',document.getElementById('wd-amt').value);
  fd.append('bank_info',bi);
  const r=await postForm('/withdraw',fd,document.getElementById('wd-btn'));
  if(r?.success){closeModal('withdrawModal');setTimeout(()=>location.reload(),1200);}
}
async function doTransfer(){
  const fd=new FormData();
  fd.append('receiver_id',document.getElementById('tr-recv').value.trim());
  fd.append('amount',document.getElementById('tr-amt').value);
  fd.append('pin',document.getElementById('tr-pin').value);
  const r=await postForm('/transfer',fd,document.getElementById('tr-btn'));
  if(r?.success){closeModal('transferModal');setTimeout(()=>location.reload(),1200);}
}
async function doExchange(){
  const fd=new FormData();
  fd.append('from_currency',document.getElementById('ex-from').value);
  fd.append('amount',document.getElementById('ex-amt').value);
  const r=await postForm('/exchange',fd,document.getElementById('ex-btn'));
  if(r?.success){closeModal('exchangeModal');setTimeout(()=>location.reload(),1200);}
}
</script>
</body>
</html>