<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ 'rtl' if lang == 'ar' else 'ltr' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0A2463">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>{{ t('tasks') }} - SocialPay</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="page-header">
  <a href="/dashboard" class="back-btn">â†</a>
  <div class="page-title-wrap">
    <div class="page-title">ğŸ“‹ {{ t('available_tasks') }}</div>
    <div class="page-subtitle">{{ tasks|length }} {{ t('tasks') }}</div>
  </div>
</div>

<div class="page-content" style="padding:14px 14px 80px">
  {% if tasks %}
    {% set icons = {'instagram':'ğŸ“¸','twitter':'ğŸ¦','facebook':'ğŸ‘¤','youtube':'â–¶ï¸','tiktok':'ğŸµ','telegram':'âœˆï¸','other':'ğŸŒ'} %}
    {% for task in tasks %}
    <div class="task-card" onclick="openTaskModal('{{ task.id }}')">
      <div class="task-icon plat-{{ task.platform|lower }}">
        {{ icons.get(task.platform|lower,'ğŸŒ') }}
      </div>
      <div class="task-info">
        <div class="task-title">{{ task.title }}</div>
        <div class="task-plat">{{ task.platform|title }} â€¢ {{ task.task_type|replace('_',' ')|title }}</div>
        <div class="task-reward">
          ğŸ’° {% if task.currency=='dollar' %}${{ "%.4f"|format(task.reward) }}{% else %}â‚¦{{ "%.0f"|format(task.reward) }}{% endif %}
        </div>
      </div>
      <div class="task-slots">{{ task.max_users - task.completed_by|length }} left</div>
    </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">ğŸ“­</div>
      <div class="empty-title">{{ t('no_tasks') }}</div>
      <div class="empty-desc">{{ t('no_tasks_desc') }}</div>
    </div>
  {% endif %}
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <a href="/dashboard" class="nav-item"><span class="nav-icon">ğŸ </span><span>Home</span></a>
  <a href="/tasks" class="nav-item active"><span class="nav-icon">ğŸ“‹</span><span>{{ t('tasks') }}</span></a>
  <div class="nav-center-wrap"><a href="/balance" class="nav-center">ğŸ’°</a></div>
  <a href="/referrals" class="nav-item"><span class="nav-icon">ğŸ‘¥</span><span>{{ t('referrals') }}</span></a>
  <a href="/profile" class="nav-item"><span class="nav-icon">ğŸ‘¤</span><span>{{ t('profile') }}</span></a>
</nav>

<!-- TASK MODAL -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="task-modal-body"></div>
  </div>
</div>

  <div id="toast-container" class="toast-container"></div>
  <script src="/static/js/app.js"></script>
<script>
const TASKS = {{ tasks|tojson }};
const ICONS = {instagram:'ğŸ“¸',twitter:'ğŸ¦',facebook:'ğŸ‘¤',youtube:'â–¶ï¸',tiktok:'ğŸµ',telegram:'âœˆï¸',other:'ğŸŒ'};

function openTaskModal(tid) {
  const task = TASKS.find(t => t.id === tid);
  if (!task) return;
  const icon = ICONS[task.platform?.toLowerCase()] || 'ğŸŒ';
  const rew = task.currency==='dollar' ? `$${parseFloat(task.reward).toFixed(4)}` : `â‚¦${parseFloat(task.reward).toFixed(0)}`;
  const slots = task.max_users - (task.completed_by?.length||0);
  document.getElementById('task-modal-body').innerHTML = `
    <div style="text-align:center;margin-bottom:20px">
      <div style="width:72px;height:72px;border-radius:22px;background:linear-gradient(135deg,var(--primary),var(--accent));display:inline-flex;align-items:center;justify-content:center;font-size:34px;margin-bottom:12px">${icon}</div>
      <div style="font-size:17px;font-weight:800">${task.title}</div>
      <div style="color:var(--muted);font-size:12px;margin-top:4px">${task.platform} â€¢ ${(task.task_type||'').replace(/_/g,' ')}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      <div class="card" style="background:linear-gradient(135deg,#E8F9F1,#D1FAE5);text-align:center;padding:12px">
        <div style="font-size:11px;color:#065F46;font-weight:700">ğŸ’° {{ t('reward') }}</div>
        <div style="font-size:22px;font-weight:800;color:#065F46">${rew}</div>
      </div>
      <div class="card" style="background:#F0F4FF;text-align:center;padding:12px">
        <div style="font-size:11px;color:var(--muted);font-weight:700">ğŸ‘¥ Slots</div>
        <div style="font-size:22px;font-weight:800">${slots}</div>
      </div>
    </div>
    <div class="card" style="background:#F9FAFB;margin-bottom:16px;padding:14px">
      <div style="font-size:11px;color:var(--muted);font-weight:700;margin-bottom:6px">ğŸ“ {{ t('task_desc') }}</div>
      <div style="font-size:14px;line-height:1.6">${task.description||'Complete this task as required.'}</div>
    </div>
    ${task.link ? `<a href="${task.link}" target="_blank" class="btn btn-outline btn-icon" style="margin-bottom:14px">ğŸ”— Open Task Link</a>` : ''}
    <div class="form-group">
      <label class="form-label">{{ t('send_proof') }}</label>
      <textarea class="form-control" id="proof-${task.id}" rows="3" placeholder="{{ t('proof_placeholder') }}"></textarea>
    </div>
    <button class="btn btn-primary" id="sub-btn-${task.id}" onclick="submitTask('${task.id}')">{{ t('submit') }}</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeModal('taskModal')">{{ t('cancel') }}</button>
  `;
  openModal('taskModal');
}

async function submitTask(tid) {
  const proof = document.getElementById(`proof-${tid}`)?.value.trim();
  if (!proof) { showToast('{{ t("fill_all_fields") }}','warning'); return; }
  const fd = new FormData();
  fd.append('task_id', tid);
  fd.append('proof', proof);
  const r = await postForm('/submit_task', fd, document.getElementById(`sub-btn-${tid}`));
  if (r?.success) { closeModal('taskModal'); setTimeout(() => location.reload(), 1400); }
}
</script>
</body>
</html>
